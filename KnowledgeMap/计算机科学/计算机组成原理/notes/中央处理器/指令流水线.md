# 指令流水线
2022.08.29

[TOC]

前面介绍的指令都是在单周期处理机中采用串行方法执行的，同一时刻 CPU 中只有一条指令在执行，因此各功能部件的使用率不高。现代计算机普遍采用指令流水线技术，同一时刻有多条指令在 CPU 的不同功能部件中并发执行，大大提高了功能部件的并行性和程序的执行效率。

## 指令流水线的基本概念

可从两方面提高处理机的并行性

①**时间上的并行技术**，将一个任务分解为几个不同的子阶段，每个阶段在不同的功能部件上并行执行，以便在同一时刻能够同时执行多个任务，进而提升系统性能，这种方法被称为**流水线技术**。

②**空间上的井行技术**，在一个处理机内设置多个执行相同任务的功能部件，并让这些功能部件并行工作，这样的处理机被称为**超标量处理机**。

### 指令流水的定义

<u>一条指令的执行过程可分解为若干阶段，每个阶段由相应的功能部件完成。如果将各阶段视为相应的流水段，则指令的执行过程就构成了一条指令流水线</u>。

假设一条指令的执行过程分为如下 5个阶段（也称功能段或流水段）：

1. 取指（IF)：从指令存储器或 Cache 中取指令
2. 译码/谈省存器 (ID)：操作控制器对指令进行译码，同时从寄存器堆中取操作数•
3. 执行/计算地址（EX）：执行运算操作或计算地址。
4. 访存(MEM)：对存储器进行读写操作。
5. 写回 (WB)：将指令执行结果写回寄存器堆。

把k＋1条指令的取指阶段提前到第k条指令的译码阶段，从而将第k+1条指令的译码阶段与第k条指令的执行阶段同时进行，如图所示。

![截屏2022-08-28 下午9.44.52](resources/指令流水线举例.png)

理想情况下，每个时钟周期都有一条指令进入流水线，每个时钟周期都有一条指令完成，每条指令的时钟周期数（即CPI）都为 1。

流水线设计的原则是，指令流水段个数以最复杂指令所用的功能段个数为准：流水段的长度以最复杂的操作所花的时间为准。假设某条指令的 5 个阶段所花的时间分别如下。①取指：200ps： ② 译码：100ps： ③ 执行：150ps; ④访存：200ps: ⑤写回：100ps，该指令的总执行时间为 750ps。按照流水线设计原则，每个流水段的长度为 200ps，所以每条指令的执行时间为1ns， 反而比串行执行时增加了 250ps。 假设某程序中有 N 条指令，单周期处理机所用的时间为Nx750ns， 而流水线处理机所用的时间为(N ＋ 4)x200ns。由此可见，流水线方式并不能缩短单条指令的执行时间，但对于整个程序来说，执行效率得到了大幅增高。

为了利于实现指令流水线，<u>指令集应具有如下特征</u>：

1. **指令长度应尽量一致**，有利于简化取指令和指令译码操作。否则，取指令所花时间长短不一，使取指部件极其复杂，且也不利于指令译码。
2. **指令格式应尽量规整**，尽量保证源寄存器的位置相同，有利于在指令未知时就可取寄存器操作数，否则须译码后才能确定指令中各寄存器编号的位置。
3. 采用 **Load/Store** 指令，其他指令都不能访问存储器，这样可把 Load/Store 指令的地址计算和运算指令的执行步骤规整在同一个周期中，有利于减少操作步骤。
4. 数据和指令在存储器中**“对齐”**存放。这样，有利于减少访存次数，使所需数据在一个流水段内就能从存储器中得到.

### 流水线的表示方法

通常用**时空图**来直观地描述流水线的执行情况。

在时空图中，横坐标表示时间，它被分割成长度相等的时间段T; 纵坐标为空间，表示当前指令所处的功能部件。在下图中，第一条指令I1 在时刻 0进入流水线，在时刻 5T 流出流水线。第二条指令 I2，在时刻下进入流水线，在时刻6T 流出流水线。以此类推，每隔一个时间T就有一条指令进入流水线，从时刻5T开始每隔一个时间下就有一条指令流出流水线。

![截屏2022-08-28 下午10.02.12](resources/时空图.png)

## 流水线的基本实现

### 流水线的数据通路

### 流水线的控制信号

### 流水线的执行过程

## 流水线的冒险与处理

## 流水线的性能指标

## 高级流水线技术

## 例题


# IO方式
2022.08.22

[TOC]

## 程序查询方式

### 摘要

> （省时间看这个总结+最后一个例题）重点：
>
> 1. CPU一旦启动I/O，必须停止现行程序的运行，并在现行程序中插入一段程序。
> 2. 主要特点:CPU有“踏步”等待现象，CPU与I/O串行工作。
> 3. 优点:接口设计简单、设备量少
> 4. 缺点：CPU在信息传送过程中要花费很多时间用于查询和等待，而且如果采用独占查询， 则在一段时间内只能和一台外设交换信息，效率大大降低
> 5. 独占查询:CPU 100%的时间都在查询I/O状态，完全串行
> 6. 定时查询:在保证数据不丢失的情况下，每隔一段时间CPU就查询一次I/O状态。查询的
>    间隔内CPU可以执行其他程序

![image-20220822163030197](resources/程序查询方式.png)

![image-20220822164408017](resources/程序查询方式2.png)

程序查询方式又称为程序控制 I/O 方式。在这种方式中，数据在 CPU 和外围设备之间 的传送完全靠计算机程序控制，是在 CPU 主动控制下进行的。当需要输入/输出时，CPU 暂停执行主程序，转去执行设备输入/输出的服务程序，根据服务程序中的 I/O 指令进行数 据传送。这是一种最简单、最经济的输入/输出方式，只需要很少的硬件。

### 输入/输出指令

当用程序实现输入/输出传送时，I/O 指令一般具有如下功能: 

1. 置“1”或置“0”，I/O 接口的某些控制触发器，用于控制设备进行某些动作，如启动、关闭设备等。
2. 测试设备的某些状态，如“忙”“准备就绪”等，以便决定下一步的操作。
3. 传送数据，当输入数据时，将 I/O 接口中数据寄存器的内容送到 CPU 某一寄存器；当输出数据时，将 CPU 中某一寄存器的内容送到 I/O 接口的数据寄存器。

### 程序查询方式的接口

图中用1~6表示了 CPU 从外设输入一个字的过程。

![image-20220822204140555](resources/程序查询方式示意图.png)

1. **设备选择电路** 接到总线上的每个设备预先都给定了设备地址码。CPU 执行 I/O 指 令时需要把指令中的设备地址送到地址总线上，用以指示 CPU 要选择的设备。每个设备接 口电路都包含一个设备选择电路，用它判别地址总线上呼叫的设备是不是本设备。如果是， 本设备就进入工作状态，否则不予理睬。**<u>设备选择电路实际上是设备地址的译码器</u>**。
2. **数据缓冲寄存器** 当输入操作时，用数据缓冲寄存器来存放从外部设备读出的数据，然后送往 CPU;当输出操作时，用数据缓冲寄存器来存放 CPU 送来的数据，以便送给外部设备输出。
3. **设备状态标志** 是接口中的标志触发器，如“忙”“准备就绪”“错误”等，用来标志设备的工作状态，以便接口对外设动作进行监视。一旦 CPU 用程序询问外部设备时，将状态标志信息取至 CPU 进行分析。

### 程序查询输入/输出方式

![image-20220822205624234](resources/程序查询方式过程.png)

**案例**：在程序查询方式的输入/输出系统中，假设不考虑处理时间，每一个查询操作需要**100**个时钟周期CPu的时钟频率为**50MHz**。现有鼠标和硬盘两个设备，而且CPU必须每秒对鼠标进行**30**次查询，硬盘以**32位字长**为单位传输数据，即**每32位被CPU查询一次**(这就是程序查询方式)，传输率$2×2^{20}B/s$。求CPU对这两个设备查询所花费的时间比率，由此可得出什么结论？

* 时间的角度

  一个时钟周期为 1/50MHz =20ns
  一个查询操作耗时 100 x 20ns = 2000ns
  1）鼠标
  每秒查询鼠标耗时 30 × 2000ns =60000ns
  查询鼠标所花费的时间比率 =$60000ns/1s =0.006\%$
  对鼠标的查询基本不影响CPU的性能
  2）硬盘
  每32位需要查询一次，每秒传送$2×2^{20}$B
  每秒需要查询$(2×2^{20}B)/4B=219$次
  查询硬盘耗时$ 2^{19}× 2000ns = 512 × 1024 × 2000ns = 1.05× 109ns$
  查询硬盘所花费的时间比率=$(1.05× 10^9ns)/1s= 105%$
  CPU将全部时间都用于对硬盘的查询也不能满足磁盘传输的要求

* 频率的角度：

  CPU的时钟频率为50MHz，即每秒$50× 10^6$个时钟周期
  1）鼠标
  每秒查询鼠标占用的时钟周期数 30 × 100 =3000
  查询鼠标所花费的时间比率 =(3000/50× 109)=0.006%
  对鼠标的查询基本不影响CPU的性能
  2)硬楹
  每秒需要查询$(2×2^{20}B)/4B=219$次
  每秒查询硬盘占用的时钟周期数 $2^{19}\times 100= 5.24×107$
  查询硬盘所花费的时间比率=(5.24× 107 )/(50× 105)=105%
  CPU将全部时间都用于对硬盘的查询也不能满足磁盘传输的要求

## 程序中断方式

### 摘要

![image-20220822163057742](resources/程序中断方式.png)

### 程序中断的基本概念

1. 中断技术的功能

   ①并性工作：实现 CPU 与IO 设备的并行工作。
   ②处理错误：处理硬件故障和软件错误。
   ③人机交互：实现人机交互，用户干预机器需要用到中断系统。
   ④多道程序：实现多道程序、分时操作，多道程序的切换需借助于中断系统。
   ⑤快速响应：实时处理需要借助中断系统来实现快速响应。
   ⑥软中断：实现应用程序和操作系统(管态程序）的切换，称为“软中断”。
   ⑦处理器间交流：多处理器系统中各处理器之间的信息交流和任务切换。

2. 程序中断方式的思想

   CPU在程序中安排好在某个时机启动某台外设，然后 CPU 继续执行当前的程序，不需要像查询方式那样一直等待外设准备就绪。一旦外设完成数据传送的准备工作，就主动向 CPU 发出中断请求，请求 CPU 为自己服务。在可以响应中断的条件下,CPU暂时中止正在执行的程序，转去执行中断服务程序为外设服务，在中断服务程序中完成一次主机与外设之间的数据传送，传送完成后，CPU 返回原来的程序。

   > 摘要：
   >
   > CPU找外设，外设忙CPU就得一直等着。现在CPU通知外设一声，外设好了来找CPU。

3. 程序中断流程

   1. **中断请求**

      1. **中断源**是请求 CPU 中断的设备或事件，一台计算机允许有多个中断源。每个中断源向 CPU 发出中断请求的时间是随机的。
      2. 为记录中断事件并区分不同的中断源，中断系统需对每个中断源设置中断请求标记触发器，当其状态为 “1”时，表示中断源有请求。这些触发器可组成**中断请求标记寄存器**，该寄存器可集中在CPU 中，也可分散在各个中断源中。
      3. 通过 **INTR** 线发出的是**可屏蔽中断**，通过 **NMI** 线发出的是**不可屏蔽中断**。可屏蔽中断的优先级最低，在关中断模式下不会被响应。不可屏蔽中断用于处理紧急和重要的事件，如时钟中断、电源掉电等，其优先级最高，其次是内部异常，即使在关中断模式下也会被响应。

   2. **中断响应判优**

      1. **中断响应优先级**是指 CPU 响应中断请求的先后顺序。由于许多中断源提出中断请求的时间都是随机的，因此当多个中断源同时提出请求时，需通过中断判优逻辑来确定响应哪个中断源的请求。
      2. 中断响应的判优通常是通过**硬件排队器**实现的。
      3. 一般决说，
         1. 不可屏蔽中断 ＞ 内部异常 ＞可屏蔽中断
         2. 内部异常中，硬件故障 ＞软件中断
         3. DMA 中断请求优先于 I/O 设备传送的中断请求
         4. 在 I/0 传送类中断请求中，高速设备优先于底速设备，输入设备优先于输出设备，实时设备优先于普通设备。
      4. 中断优先级包括**响应优先级**和**处理优先级**，响应优先级在硬件线路上是固定的，不便改动，处理优先级可利用中断屏蔽技术动态调整，以实现多重中断，具体在后文中介绍。

   3. **CPU 响应中断的条件**

      1. CPU 在满足一定的条件下响应中断源发出的中断请求，并经过一些特定的操作，转去执行中断服务程序。CPU 响应中断必须满足以下 3个条件：
         * 中断源有中断请求。
         * CPU 允许中断及开中断（异常和不可屏蔽中断不受此限制）。
         * 一条指令执行完毕（异常不受此限制），且没有更紧迫的任务。
      2. 注意：I/O 设备的就绪时间是随机的，而 CPU 在统一的时刻即每条指令执行阶段结束前向接口发出中断查询信号，以获取 I/O 的中断请求，也就是说，CPU 响应中断的时间是在每条指令执行阶段的结束时刻。这里说的中断仅指I/O中断，内部异常不属于此类情况。

   4. **中断响应过程**

      CPU 响应中断后，经过某些操作，转去执行中断服务程序。这些操作是由硬件直接实现的，我们将它称为中断隐指令。中断隐指令并不是指令系统中的一条真正的指令，只是一种虚拟的说法，本质上是硬件的一系列自动操作。它所完成的操作如下：

      1. **关中断**。CPU 响应中断后，首先要保护程序的断点和现场信息，<u>在保护断点和现场的过程中，CPU 不能响应更高级中断源的中断请求</u>。否则，若断点或现场保存不完整，在中断服务程序结束后，就不能正确地恢复并继续执行现行程序。

      2. **保存断点**。为保证在中断服务程序执行完后能正确地返回到原来的程序，必须将原程序的断点(指令无法直接读取的PC 和PSW 的内容）保存在栈或特定奇存器中。

         **注意异常和中断的差异**：异常指令通常并没有执行成功，异常处理后要重新执行，所以
         其断点是当前指令的地址。中断的断点则是下一条指令的地址，
         ③ 引出中断服务程序。识别中断源，将对应的服务程序入口地址送入程序计数器 PC。有
         两种方法识别中断源：硬件向量法和软件查询法。本节主要讨论比较常用的向量中断。
         (5）中断向量
         中断识别分为向量中断和非向量中断两种。非向量中断即软件查询法，第5章已介绍。

## DMA方式

![image-20220822163117394](resources/DMA方式.png)
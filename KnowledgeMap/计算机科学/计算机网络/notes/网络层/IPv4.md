# IPv4

2022.3.2

## IPv4分组

### IPv4分组格式

![ipv4分组](resources/ipv4分组.png)

1. 版本（1字节）：IPv4是4

2. 首部长度（1字节）

   1. 可以表示0-15，以**4字节**为单位。
   2. 当首部长度字段为15，首部的长度的$$15\cdot 4B=60B$$，常用的首部长度为20B。

3. 区分服务

4. 总长度（4字节）

   1. 单位是**1字节**
   2. 数据报最长长度为$$2^{16}-1=65535B$$。
   3. 以太网帧长最大为1500B。

5. 标识（16bits）

   它是一个计数器，每产生一个数据报就加1，并赋值给标识字段。但它并不是“序号”（因为P是无连接服务）。当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号，以便能正确重装成原来的数据报。

6. 标志（3bits）：[保留, DF, MF]

   1. MF(More Fragment)：最低字段。MF=1代表还有后边分片，MF=0代表是最后一个分片。
   2. DF(Don't Fragment)：中加字段。DF=1，不允许分片；DF=0，允许分片。
   3. 最高字段，保留。

7. 片偏移（13bits）：

   1. 单位**8字节**
   2. 代表本分片在原分片中的位置

8. 生存时间TTL（8bits）：跳数，转发一次减一个一。TTL=0时丢弃。

9. 协议（8bits）

   1. TCP：6
   2. UDP：17

10. 首部校验和（16bits）：只验证首部

11. 源IP地址（32bits）

12. 目的IP地址（32bits）

### IP数据报分片

4000B(20B+3980B)的IP数据报，要发送到MTU=1500B的链路上：

原：

[20+3980]{标识:777, MF=0, DF=0}，将**3980分成1480+1480+1020**

分片后：

[20+1480]{标识:777, MF=1, DF=0, 片偏移=0}

[20+1480]{标识:777, MF=1, DF=0, 片偏移=185}, **1480/8=185**

[20+1020]{标识:777, MF=0, DF=0, 片偏移=370}

### IPv4地址

<img src="resources/分类.png" alt="分类" style="zoom:67%;" />

![特殊的IP地址](resources/特殊的IP地址.png)

| 含义                                                         | 网络号 | 主机号 | 作为IP分组源地址 | 作为IP分组目的地址 |
| ------------------------------------------------------------ | ------ | ------ | ---------------- | ------------------ |
| 本网络                                                       | 全0    |        |                  |                    |
| 某网络                                                       | 特定值 |        |                  |                    |
| 还回测试                                                     | 127    |        |                  |                    |
| 整个网络                                                     | 全1    |        |                  |                    |
| 网络地址/本主机                                              |        | 全0    |                  |                    |
| 网络内主机地址                                               |        | 特定值 |                  |                    |
| 网络内所有主机                                               |        | 全1    |                  |                    |
| 本网络本主机<br />（DHCP,主机没接入网络,主机号全0）<br />路由表中表示默认路由（整个Internet网络） | 全0    | 全0    | √                | x                  |
| 本网络的特定主机                                             | 全0    | 特定值 | √                | x                  |
| 本网络内广播                                                 | 全0    | 全1    | x                | x                  |
| 某网络                                                       | 特定值 | 全0    | x                | √                  |
| 某网络某主机                                                 | 特定值 | 特定值 | √                | √                  |
| 某网络内广播                                                 | 特定值 | 全1    | x                | √                  |
|                                                              | 全1    | 全0    |                  |                    |
|                                                              | 全1    | 特定值 |                  |                    |
| 受限广播地址，整个TCP/IP内广播<br />但因为路由器不转发，所以等同于本网络广播 | 全1    | 全1    |                  |                    |



### 网络地址转换-NAT



## 子网划分与子网掩码、CIDR

### 子网划分



### 子网掩码



### 无分类编址CIDR



## ARP、DHCP与ICMP

### ARP



### DHCP



### ICMP



